<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8" />
    <meta name="author" content="TES286" />
    <link rel="shortcut icon" type="image/x-icon"
        href="https://share.xn--4gq.cn.eu.org/EcgamA_FLhBBuHKY0IXhV2wBEfcq4hsKbr62o_8_B2agTA" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Online Onedrive Share Viewer can give you a download link for anything that share from Onedrive(Personal Edition), You an use the link to do any, like download it on the enviroment without UI" />
    <title>Online Onedrive Share Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" media="all" />
    <link rel="stylesheet" href="https://files.tes286.site/css/iconfront.folderopen-fill-file-fill.css"
        media="asyncload" />
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.qrcode@1.0.3" async="async"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" async="async"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8" async="async"></script>
    <script src="https://hm.baidu.com/hm.js?a763a746dfb5a5a8a830a184931a2e8f" async="async"></script>
</head>
<script type="text/javascript">
    var _hmt = _hmt || [];
    var DL_ROOT = "https://1drv.tes286.top/";
    function load_date() {
        if (location.hash) {
            var hash = location.hash.substring(1);
            // 支持: url=***&path=***
            // 解析
            var theRequest = new Object();
            strs = hash.split("&");
            for (var i = 0; i < strs.length; i++) {
                theRequest[strs[i].split("=")[0]] = decodeURIComponent(strs[i].split("=")[1]);
            }
            // 设置值
            window.test_flag = false
            if (theRequest['path']) {
                $("#Path").val(theRequest['path']);
            }
            if (theRequest['url']) {
                $("#ShareLink").val(theRequest['url']);
            }
            if (theRequest['dl_root']) {
                window.DL_ROOT = theRequest['dl_root'];
            }
            if (theRequest['test']) {
                window.test_flag = true;
            }
        }
    }
    function main() {
        load_date();
        if ($("#ShareLink").val() != "") {
            start();
        }
        if (window.test_flag) {
            test(1);
        }
        window.paypalAlreadySetup = false;
        var clipboard = new ClipboardJS('#copy');
        clipboard.on('success', function (e) {
            console.log('Copy', e);
        });
        clipboard.on('error', function (e) {
            console.log('Copy Error', e);
        });
        show_wechat();
        links = document.getElementsByTagName("link");
        // 如果media为asyncload，则改成all加载
        for (var i = 0; i < links.length; i++) {
            if (links[i].getAttribute("media") == "asyncload") {
                links[i].setAttribute("media", "all");
            }
        }
    }
    function build_dl_url(token, id) {
        return DL_ROOT + "u/s!" + token + "/" + id;
    }
    function start() {
        // 设置hash
        hash = "url=" + encodeURIComponent($("#ShareLink").val()) + "&path=" + encodeURIComponent($("#Path").val());
        if (DL_ROOT != "https://1drv.tes286.top/") {
            hash += "&dl_root=" + encodeURIComponent(DL_ROOT);
        }
        if (window.test_flag) {
            hash += "&test=1";
        }
        location.href = location.href.split("#")[0] + "#" + hash;

        // 检查链接
        if ($("#ShareLink").val() == "") {
            console.error("ShareLink is empty");
            error("链接为空");
            return;
        }
        try {
            var urlOBJ = new URL($("#ShareLink").val());
            var url = urlOBJ.origin + urlOBJ.pathname;
        } catch (e) {
            console.error("ShareLink is invalid");
            error("链接无效");
            return;
        }
        // 格式: https://1drv.ms/{ch}/s!{token}

        // 提取出token
        var token = url.substring(url.indexOf("!") + 1);

        // url: https://api.onedrive.com/v1.0/shares/s!{token}/driveItem
        // 拼接url
        if ($("#Path").val() == "") {
            var api = "https://api.onedrive.com/v1.0/shares/s!" + token + "/driveItem/children";
        } else {
            var _p = $("#Path").val().split("/");
            var p = "";
            for (var i = 0; i < _p.length; i++) {
                if (_p[i] != "") {
                    p += "/" + _p[i];
                }
            }
            $("#Path").val(p);
            var api = "https://api.onedrive.com/v1.0/shares/s!" + token + "/driveItem:" + $("#Path").val() + ":/children";
        }
        // 清理 #ShareTable
        $("#ShareTable").empty();
        // 发送请求
        $.ajax({
            url: api,
            type: "GET",
            success: function (data) {
                // 检查是否成功
                if (data.error) {
                    console.error(data.error.message);
                    error(data.error.message);
                    return;
                }

                value = data.value; // 数组
                // 循环数组
                for (var i = 0; i < value.length; i++) {
                    // 判断是否是文件夹 (有folder就是文件夹, 否则就是文件)
                    if (value[i].folder != undefined) {
                        // 是文件夹
                        // 添加到文件夹列表 (#ShareTable)
                        $('#ShareTable').append('<tr id="' + i + '"></tr>');
                        // 图标
                        $('#' + i).append('<td><span class="iconfont icon-folderopen-fill"></i></td>');
                        // 添加文件夹名称
                        $('#' + i).append('<td>' + value[i].name + '</td>');
                        // 添加文件夹ID
                        $('#' + i).append('<td>' + value[i].id + '</td>');
                        // 添加文件夹链接
                        $('#' + i).append('<td><buton class="btn btn-link btn-xs" onclick="javascript:update(\'' + value[i].name + '\')">进入</button></td>');
                    } else {
                        // 是文件
                        // 添加到文件列表 (#ShareTable)
                        $('#ShareTable').append('<tr id="' + i + '"></tr>');
                        // 图标
                        $('#' + i).append('<td><span class="iconfont icon-file-fill"></i></td>');
                        // 添加文件名称
                        $('#' + i).append('<td>' + value[i].name + '</td>');
                        // 添加文件ID
                        $('#' + i).append('<td>' + value[i].id + '</td>');
                        // 添加文件链接
                        $('#' + i).append('<td><a href="' + build_dl_url(token, value[i].id) + '">' + build_dl_url(token, value[i].id) + '</a></td>');
                    }
                }
                $("#Error").empty();
                $("#ErrorZone").hide();
            },
            error: function (e) {
                console.error('Request failed: ', e);
                error("请求失败: " + e.responseText);
            }
        });
        update_path_title()
    }
    function test() {
        window.test_flag = true;
        $("#ShareLink").val("https://1drv.ms/u/s!Anf3w9LYLCm3aq7TqzEUPdHXQW4?e=KTemKq");
        $("#Path").val("");
        $("#test").show();
        DL_ROOT = "http://localhost:5000/";
        if (arguments[0] != 1) {
            start();
        }
    }
    function update(path) {
        var _path = $("#Path").val();
        if (_path == "") {
            $("#Path").val(path);
        } else {
            $("#Path").val(_path + "/" + path);
        }
        start();
    }
    function update_path_title() {
        var _path = $("#Path").val();
        p = _path.split("/");
        $("#PathTitle").empty();
        $("#PathTitle").append('<li><a onclick="javascript:cd(\'/\')">root</li>');
        for (var i = 0; i < p.length; i++) {
            if (p[i] == "") {
                continue;
            }
            $("#PathTitle").append('<li><a onclick="javascript:cd(\'/' + join(p, '/', true, i + 1) + '\')">' + p[i] + "</li>");
        }
    }
    function error(msg) {
        $("#Error").empty();
        $("#Error").append(msg);
        $("#ErrorZone").show();
    }
    function join(date, spliter, skip_empty, n) {
        if (skip_empty == undefined) {
            skip_empty = true;
        }
        if (spliter == undefined) {
            spliter = " ";
        }
        if (n == undefined) {
            n = date.length;
        }
        var result = "";
        for (var i = 0; i < n; i++) {
            if (skip_empty && date[i] == "") {
                continue;
            }
            result += spliter + date[i];
        }
        return result;
    }
    function share(url) {
        $("#link").val(url);
        $('#qrcode').empty();
        $('#qrcode').qrcode({
            text: url,
            width: 128,
            height: 128,
            colorDark: "#000000",
            colorLight: "#ffffff"
        });
        $("#share").show();
    }
    function cd(path) {
        $("#Path").val(path);
        start();
    }
</script>

<body onload="javascript:main();">
    <!-- header -->
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#headers-navbar">
                    <span class="sr-only">切换导航</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://onedrivepanel.tes286.top/">TES286 Onedrive Panel</a>
            </div>
            <div class="collapse navbar-collapse" id="headers-navbar">
                <ul class="nav navbar-nav">
                    <li><a href="https://onedrivepanel.tes286.top/">Panel</a></li>
                    <li class="active"><a href="https://onedrivepanel.tes286.top/shareView.html">Share View(Personal
                            Only)</a></li>
                    <li class="navbar-right">
                        <p class="navbar-text">Onedrive为Microsoft产品,与本站无关,最终仍使用Microsoft的api</p>
                    </li>
                </ul>
                </ul>
            </div>
        </div>
    </nav>
    <div style="height: 50px;"></div>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1 class="text-center text-primary">Onedrive分享查看</h1>
            </div>
        </div>
        <!-- 标头-->
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">分享链接</h3>
                    </div>
                    <div class="panel-body">
                        链接:<input id="ShareLink" type="url" height="500px" class="form-control"
                            placeholder="https://1drv.ms/x/s!xxxxxxx..." /><br />
                        路径:(可选)<input id='Path' type="text" value="/" height="500px" class="form-control"
                            placeholder="/" /><br />
                        <button id="Submit" class="btn btn-primary" onclick="javascript:start()">Submit</button>
                        <button id="clear" class="btn btn-primary"
                            onclick="javascript:$('#ShareLink').val('')">Clear</button>
                        <button id="shareButton" class="btn btn-primary"
                            onclick="javascript:share(location.href)">Share</button>
                        <button class="btn btn-primary" onclick="javascript:$('#donate').show()">Donate</button>
                        <div id="test" style="display: none;">
                            <button class="btn btn-primary" onclick="javascript:location.reload()">Reload</button>
                            <button class="btn btn-primary" onclick="javascript:error('Test Error')">Error</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 面包屑导航 -->
        <ul class="breadcrumb" id="PathTitle">
            <li><a onclick="javascript:cd('/')">root</a></li>
        </ul>
        <!-- 错误 -->
        <div class="row" id="ErrorZone" style="display: none;">
            <div class="col-md-12">
                <div class="panel panel-danger">
                    <div class="panel-heading">
                        <h3 class="panel-title">错误</h3>
                    </div>
                    <div class="panel-body">
                        <strong>
                            <p id="Error" class="text-danger"></p>
                        </strong>
                        <button class="btn btn-danger btn-xs" onclick="javascript:$('#ErrorZone').hide()">关闭</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 分享 -->
        <div class="row" id="share" style="display: none;">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">分享</h3>
                    </div>
                    <div class="panel-body">
                        <div id='qrcode'></div>
                        <input id="link" class="form-control" />
                        <button class="btn btn-primary btn-xs" data-clipboard-target="#link"
                            data-clipboard-action="copy" id="copy">复制</button>
                        <button class="btn btn-primary btn-xs" onclick="javascript:$('#share').hide()">关闭</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 捐赠 -->
        <div class="row" id="donate" style="display: none;">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">捐赠</h3>
                    </div>
                    <div class="panel-body">
                        <ul class="nav nav-tabs">
                            <script type="text/javascript">
                                function show_wechat() {
                                    $("#donate-alipay").hide();
                                    $('#donate-paypal').hide();
                                    $("#donate-wechat").show();
                                    $("#d_wx").addClass("active");
                                    $("#d_ap").removeClass("active");
                                    $("#d_pp").removeClass("active");
                                    $("#qrcode-wechat").empty();
                                    $('#qrcode-wechat').qrcode({
                                        render: "canvas",
                                        width: 200,
                                        height: 200,
                                        text: "wxp://f2f00gd_B-CYN4Q_2i4W2KcwUPZTA8LZHn0TButK77N3hAQ"
                                    });
                                }
                                function show_alipay() {
                                    $("#donate-wechat").hide();
                                    $('#donate-paypal').hide();
                                    $("#donate-alipay").show();
                                    $("#d_wx").removeClass("active");
                                    $("#d_ap").addClass("active");
                                    $("#d_pp").removeClass("active");
                                    $('#qrcode-alipay').empty();
                                    $('#qrcode-alipay').qrcode({
                                        render: "canvas",
                                        width: 200,
                                        height: 200,
                                        text: "https://qr.alipay.com/fkx11387gtiblxh4um1l593"
                                    });
                                }
                            </script>
                            <li id="d_wx"><a onclick="javascript:show_wechat()">微信支付</a></li>
                            <li id="d_ap"><a onclick="javascript:show_alipay()">支付宝支付</a></li>
                        </ul>
                        <div id="donate_context">
                            <div id="donate-wechat" style="display: none;">
                                <div id="qrcode-wechat"></div>
                                <p>微信支付</p>
                            </div>
                            <div id="donate-alipay" style="display: none;">
                                <div id="qrcode-alipay"></div>
                                <p>支付宝支付</p>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-xs" onclick="javascript:$('#donate').hide();">关闭</button>
                </div>
            </div>
        </div>
        <!-- 分享列表 -->
        <div class="row">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">数据</h3>
                    </div>
                    <div class="panel-body">
                        <div id="ShareLinkList">
                            <!-- 文件列表 -->
                            <table class="table table-striped table-hover table-condensed table-bordered table-responsive">
                                <thead>
                                    <tr>
                                        <th>*</th>
                                        <th>名称</th>
                                        <th>ID</th>
                                        <th>链接</th>
                                    </tr>
                                </thead>
                                <tbody id='ShareTable'>

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>